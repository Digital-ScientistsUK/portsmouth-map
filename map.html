<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Coverage Map</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    .controls {
      padding: 10px;
      background: #fff;
    }
  </style>
</head>
<body>

<div class="controls">
  <input id="search" placeholder="Postcode, town or county" />
  <button onclick="searchLocation()">Search</button>
  <button onclick="resetMap()">Reset</button>
</div>

<div id="map"></div>

<script>
  const map = L.map("map").setView([54.5, -2.5], 6);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "Â© OpenStreetMap contributors",
  }).addTo(map);

  let coverageLayer;

  fetch("coverage.geojson")
  .then((res) => res.json())
  .then((data) => {
    const center = data.features[0].geometry.coordinates;

    coverageLayer = L.circle([center[1], center[0]], {
      radius: 16093, // 10 miles in metres
      color: "#0066ff",
      weight: 2,
      fillOpacity: 0.3
    }).addTo(map);

    map.fitBounds(coverageLayer.getBounds());
  });


  function searchLocation() {
    const query = document.getElementById("search").value;
    if (!query) return;

    fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${query}`
    )
      .then((res) => res.json())
      .then((results) => {
        if (!results.length) return alert("Location not found");

        const latlng = [
          parseFloat(results[0].lat),
          parseFloat(results[0].lon),
        ];

        map.setView(latlng, 10);

        coverageLayer.eachLayer((layer) => {
          if (layer.getBounds().contains(latlng)) {
            layer.setStyle({
              fillOpacity: 0.6,
              color: "#28a745",
            });
          } else {
            layer.setStyle({
              fillOpacity: 0.05,
              color: "#cccccc",
            });
          }
        });
      });
  }

  function resetMap() {
    coverageLayer.eachLayer((layer) => {
      layer.setStyle({
        fillOpacity: 0.3,
        color: "#0066ff",
      });
    });

    map.fitBounds(coverageLayer.getBounds());
    document.getElementById("search").value = "";
  }
</script>

</body>
</html>
